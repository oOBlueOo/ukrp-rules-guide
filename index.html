<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UKRP Rules & Community</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#151e2e',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        brand: {
                            blue: '#3B82F6',
                            glow: '#60A5FA',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-general: #3B82F6;
            --color-whitelist: #F59E0B;
            --color-core-rp: #10B981;
            --color-combat: #EF4444;
            --color-crime: #DC2626;
            --color-economy: #34D399;
            --color-zones: #F97316;
            --color-aircraft: #94A3B8;
            --color-discord: #5865F2;
        }

        body {
            background-color: #020617; /* Slate 950 */
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Rule Card Styling */
        .rule-card {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left-width: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rule-card:hover {
            transform: translateY(-4px);
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Dynamic Border Colors */
        .general-rule { border-left-color: var(--color-general); }
        .whitelist-rule { border-left-color: var(--color-whitelist); }
        .core-rp-rule { border-left-color: var(--color-core-rp); }
        .combat-rule { border-left-color: var(--color-combat); }
        .crime-rule { border-left-color: var(--color-crime); }
        .economy-rule { border-left-color: var(--color-economy); }
        .zones-rule { border-left-color: var(--color-zones); }
        .aircraft-rule { border-left-color: var(--color-aircraft); }
        .discord-rule { border-left-color: var(--color-discord); }

        /* New Tag */
        .new-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.4);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
        
        /* Base Rule Tag */
        .base-tag {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Nav Buttons */
        .nav-btn {
            position: relative;
            color: #94a3b8;
            transition: all 0.3s ease;
        }
        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0%;
            height: 2px;
            background: #3B82F6;
            transition: width 0.3s ease;
        }
        .nav-btn:hover { color: white; }
        .nav-btn.active { color: white; }
        .nav-btn.active::after { width: 100%; }

        /* Category Buttons */
        .cat-btn {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.2s;
        }
        .cat-btn:hover { transform: translateY(-2px); background: rgba(51, 65, 85, 0.8); }
        .cat-btn.active {
            background: var(--btn-color, #3B82F6);
            border-color: transparent;
            color: #0f172a;
            font-weight: 700;
            box-shadow: 0 0 15px var(--btn-glow, rgba(59, 130, 246, 0.4));
        }

        /* Star Rating */
        .rating-star {
            cursor: pointer;
            font-size: 2rem;
            color: #334155;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .rating-star:hover { transform: scale(1.2); }
        .rating-star.selected, .rating-star.hover-active {
            color: #F59E0B;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        /* Page Transitions */
        .page-section {
            opacity: 0;
            transform: translateY(10px);
            display: none;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .page-section.active-page {
            display: block;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .modal {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Smooth inputs */
        input, textarea, select {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .offline-banner {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center gap-3 cursor-pointer" onclick="switchPage('rules')">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-tight">UKRP</h1>
                        <p class="text-xs text-gray-400 font-medium tracking-wider">OFFICIAL HANDBOOK</p>
                    </div>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center space-x-8">
                    <button onclick="switchPage('rules')" id="nav-rules" class="nav-btn active text-sm font-semibold uppercase tracking-wider py-2">Rule Book</button>
                    <button onclick="switchPage('reviews')" id="nav-reviews" class="nav-btn text-sm font-semibold uppercase tracking-wider py-2">Reviews & Community</button>
                    
                    <div class="h-6 w-px bg-slate-700 mx-2"></div>

                    <button id="adminLoginBtn" onclick="openLoginModal()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium">
                        Staff Login
                    </button>
                    <div id="adminPanel" class="hidden items-center space-x-3">
                        <span class="text-xs text-green-400 font-mono bg-green-400/10 px-2 py-1 rounded border border-green-400/20">ADMIN MODE</span>
                        
                        <button onclick="openRuleModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20 transition-all hover:scale-105 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add Rule
                        </button>
                        <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm font-medium">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[calc(100vh-80px)]">

        <!-- =======================
             PAGE: RULES
             ======================= -->
        <div id="page-rules" class="page-section active-page">
            
            <!-- Search & Filter Header -->
            <div class="mb-10 space-y-6">
                <!-- Status Banner for DB Connection Issues -->
                <div id="dbStatusBanner" class="hidden offline-banner px-4 py-3 rounded-xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span class="text-sm font-medium">Read-Only Mode: Database access denied. Using offline rulebook.</span>
                    </div>
                    <button onclick="this.parentElement.classList.add('hidden')" class="text-red-400 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>

                <div class="bg-slate-900/50 p-1 rounded-xl border border-slate-700/50 flex shadow-2xl relative overflow-hidden group">
                    <!-- Pointer events none fixed -->
                    <div class="pointer-events-none absolute inset-0 bg-gradient-to-r from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="pl-4 flex items-center justify-center pointer-events-none">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search for rules, tags, or keywords..." 
                        class="w-full bg-transparent border-none text-white px-4 py-4 focus:ring-0 text-lg placeholder-slate-500 z-10"
                        onfocus="this.parentElement.classList.add('ring-2', 'ring-blue-500/50')"
                        onblur="this.parentElement.classList.remove('ring-2', 'ring-blue-500/50')">
                    <button id="clearSearchBtn" class="hidden px-6 text-slate-400 hover:text-white transition z-10">Clear</button>
                </div>

                <!-- Categories -->
                <div class="flex flex-wrap gap-2 justify-center lg:justify-start" id="categoryButtonsContainer">
                    <button onclick="filterByCategory('All')" data-category="All" class="cat-btn active px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: #e2e8f0; --btn-glow: rgba(255,255,255,0.2)">All Rules</button>
                    <button onclick="filterByCategory('General')" data-category="General" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-general)">General</button>
                    <button onclick="filterByCategory('Whitelist')" data-category="Whitelist" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-whitelist)">Whitelist</button>
                    <button onclick="filterByCategory('Core RP')" data-category="Core RP" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-core-rp)">Core RP</button>
                    <button onclick="filterByCategory('Combat')" data-category="Combat" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-combat)">Combat</button>
                    <button onclick="filterByCategory('Crime')" data-category="Crime" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-crime)">Crime</button>
                    <button onclick="filterByCategory('Economy')" data-category="Economy" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-economy)">Economy</button>
                    <button onclick="filterByCategory('Zones')" data-category="Zones" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-zones)">Zones</button>
                    <button onclick="filterByCategory('Aircraft')" data-category="Aircraft" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-aircraft)">Aircraft</button>
                    <button onclick="filterByCategory('Discord')" data-category="Discord" class="cat-btn px-4 py-2 rounded-lg text-sm font-medium text-slate-300" style="--btn-color: var(--color-discord)">Discord</button>
                </div>
            </div>

            <!-- Rules Grid -->
            <div id="ruleContainer" class="pb-20 min-h-[400px]">
                <div class="flex flex-col items-center justify-center h-64 text-slate-500">
                    <div class="loading-spinner mb-4"></div>
                    <p>Loading Rules...</p>
                </div>
            </div>
        </div>


        <!-- =======================
             PAGE: REVIEWS & COMMUNITY
             ======================= -->
        <div id="page-reviews" class="page-section">
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left Column: Community Links -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-2xl p-8 text-center">
                        <h2 class="text-3xl font-bold text-white mb-2">Join the Community</h2>
                        <p class="text-slate-400 mb-8">Connect with other players, get support, or support the server.</p>
                        
                        <div class="space-y-4">
                            <a href="https://discord.gg/UNITINGKINGDOMSRP" target="_blank" class="group flex items-center justify-between p-4 bg-[#5865F2] hover:bg-[#4752C4] rounded-xl transition-all hover:scale-[1.02] shadow-lg shadow-[#5865F2]/20">
                                <div class="flex items-center">
                                    <svg class="w-8 h-8 text-white mr-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.2 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.53.31-1.07.57-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.48-1.33 5.3-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-9.21-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.85 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.85 2.12-1.89 2.12z"/></svg>
                                    <div class="text-left">
                                        <div class="font-bold text-white">Join Discord</div>
                                        <div class="text-xs text-blue-200">Get whitelisted & support</div>
                                    </div>
                                </div>
                                <svg class="w-5 h-5 text-white/50 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </a>

                            <a href="https://unitingkingdomsrp.co.uk/" target="_blank" class="group flex items-center justify-between p-4 bg-pink-600 hover:bg-pink-700 rounded-xl transition-all hover:scale-[1.02] shadow-lg shadow-pink-600/20">
                                <div class="flex items-center">
                                    <svg class="w-8 h-8 text-white mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <div class="text-left">
                                        <div class="font-bold text-white">Server Store (Tebex)</div>
                                        <div class="text-xs text-pink-200">Support us & get perks</div>
                                    </div>
                                </div>
                                <svg class="w-5 h-5 text-white/50 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </a>
                        </div>
                    </div>

                    <!-- Placeholder for image or announcement -->
                    <div class="rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
                        <img src="https://i.gyazo.com/fad0f3f014c5988a6ac3218d7409e33f.png" alt="Map Preview" class="w-full h-48 object-cover opacity-80 hover:opacity-100 transition-opacity">
                        <div class="p-4 bg-slate-800">
                            <h3 class="text-white font-bold">Explore the City</h3>
                            <p class="text-sm text-slate-400">Familiarize yourself with the zones.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Review Form -->
                <div class="lg:col-span-7">
                    <div class="bg-slate-800/80 backdrop-blur border border-slate-700 rounded-2xl p-8 relative overflow-hidden">
                        <!-- Decorative bg element -->
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl"></div>

                        <h3 class="text-2xl font-bold text-white mb-2 relative z-10">Leave a Review</h3>
                        <p class="text-slate-400 mb-8 relative z-10">Share your experience with the UKRP community. Reviews are posted to our public channels.</p>
                        
                        <form id="reviewForm" onsubmit="submitReview(event)" class="space-y-6 relative z-10">
                            
                            <!-- Rating -->
                            <div class="flex flex-col items-center p-6 bg-slate-900/50 rounded-xl border border-slate-700/50">
                                <label class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Your Rating</label>
                                <div id="reviewRating" class="flex space-x-2">
                                    <span class="rating-star" data-value="1" title="Poor">★</span>
                                    <span class="rating-star" data-value="2" title="Fair">★</span>
                                    <span class="rating-star" data-value="3" title="Good">★</span>
                                    <span class="rating-star" data-value="4" title="Great">★</span>
                                    <span class="rating-star" data-value="5" title="Excellent">★</span>
                                </div>
                                <input type="hidden" id="selectedRating" name="rating" required>
                                <div id="ratingText" class="h-5 text-sm font-medium text-brand-glow mt-2"></div>
                            </div>

                            <!-- Inputs -->
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label for="reviewName" class="block text-sm font-medium text-slate-300 mb-2">Character Name / IGN</label>
                                    <input type="text" id="reviewName" name="name" required maxlength="50" placeholder="e.g. Captain Pickle"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none placeholder-slate-600">
                                </div>
                                
                                <div>
                                    <label for="reviewContent" class="block text-sm font-medium text-slate-300 mb-2">Your Review</label>
                                    <textarea id="reviewContent" name="content" rows="5" required maxlength="500" placeholder="Tell us what you enjoy about the server..."
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-none placeholder-slate-600"></textarea>
                                    <div class="text-right text-xs text-slate-500 mt-1"><span id="charCount">0</span>/500</div>
                                </div>
                            </div>

                            <div id="reviewMessage" class="text-center font-medium min-h-[24px]"></div>

                            <button type="submit" class="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-500/25 transition-all transform hover:scale-[1.01] active:scale-[0.99]">
                                Submit Review
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Admin Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="modal-content bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-sm relative transform scale-95 transition-all">
            <button onclick="closeModal('loginModal')" class="absolute top-4 right-4 text-slate-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-white">Staff Access</h2>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <input type="text" id="adminUser" placeholder="Username" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <input type="password" id="adminPass" placeholder="Password" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                </div>
                <div id="loginError" class="text-red-400 text-sm text-center hidden bg-red-400/10 py-2 rounded">Invalid credentials</div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">Login</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Rule Modal -->
    <div id="ruleModal" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="modal-content bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-lg relative">
            <button onclick="closeModal('ruleModal')" class="absolute top-4 right-4 text-slate-400 hover:text-white">✕</button>
            <h2 id="modalTitle" class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Manage Rule</h2>
            <form onsubmit="handleRuleSubmit(event)" class="space-y-4">
                <input type="hidden" id="ruleId">
                <input type="hidden" id="ruleDocId"> <!-- Firestore Doc ID -->
                
                <div>
                    <label class="block text-slate-400 text-xs uppercase font-bold mb-1">Category</label>
                    <select id="ruleCategory" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none">
                        <option value="General">General</option>
                        <option value="Whitelist">Whitelist</option>
                        <option value="Core RP">Core RP</option>
                        <option value="Combat">Combat</option>
                        <option value="Crime">Crime</option>
                        <option value="Economy">Economy</option>
                        <option value="Zones">Zones</option>
                        <option value="Aircraft">Aircraft</option>
                        <option value="Discord">Discord</option>
                    </select>
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/4">
                        <label class="block text-slate-400 text-xs uppercase font-bold mb-1">Ref #</label>
                        <input type="number" id="ruleCustomId" required class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none">
                    </div>
                    <div class="w-3/4">
                        <label class="block text-slate-400 text-xs uppercase font-bold mb-1">Title</label>
                        <input type="text" id="ruleTitle" required class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-400 text-xs uppercase font-bold mb-1">Content</label>
                    <textarea id="ruleText" required rows="5" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white outline-none"></textarea>
                </div>
                <div class="flex items-center bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                    <input type="checkbox" id="ruleNew" class="w-5 h-5 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                    <label for="ruleNew" class="ml-3 text-sm text-slate-300">Mark as "NEW" update</label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('ruleModal')" class="text-slate-400 hover:text-white px-4 py-2 text-sm font-medium">Cancel</button>
                    <button type="submit" id="saveRuleBtn" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-green-600/20">Save Rule</button>
                </div>
            </form>
        </div>
    </div>

    <button id="backToTopBtn" class="fixed bottom-8 right-8 p-4 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-2xl opacity-0 translate-y-10 transition-all duration-300 z-40">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIG & INIT
        // UPDATED: Dynamically checks for environment config to fix "Permission Denied" errors
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDy_79SDkFox2548J7JMEBQN2KVTw7-wHw",
            authDomain: "rules-875fd.firebaseapp.com",
            projectId: "rules-875fd",
            storageBucket: "rules-875fd.firebasestorage.app",
            messagingSenderId: "371472035516",
            appId: "1:371472035516:web:f94f74869c8d18c3d2aab9",
            measurementId: "G-TRD6LGCCRV"
        };
        
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Ensure appId is a string and handle potential undefined env var gracefully
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? String(__app_id) : 'default-ukrp-app';
        
        const rulesColPath = ['artifacts', appId, 'public', 'data', 'ukrp_rules']; // Firestore path

        // --- HARDCODED BASE RULES (Read-Only) ---
        window.staticBaseRules = [
            { customId: 1, category: "General", title: "Reporting Violations", text: "All rule breaks must be reported through the designated channels (e.g., in-game reporting, Discord ticket system). Do not attempt to police other players yourself. When making a report/ticket in the discord you must have evidence to back up your claims. Do not discuss player bans or ban reasoning at any point.", tags: ["reporting", "staff", "police", "ticket", "evidence"], new: false },
            { customId: 2, category: "General", title: "Respect, Bullying, and Hate Speech", text: "Respect all other players in and out of RP, do not take in-game feuds to real-life. No OOC drama/toxicity. Do not make personal attacks. Use of directed bigoted language, including slurs which degrade another person or group of people based on gender, race, sexual orientation, nationality, religion, disability, etc., can result in any punishment chosen by the responding administrator.", tags: ["respect", "toxicity", "bullying", "hate speech", "slurs"], new: false },
            { customId: 3, category: "General", title: "Metagaming & Stream-Sniping (Updated)", text: "The use of any knowledge obtained by means not through in-character interactions (OOC), for gain in-character (IC), or that harms another player or their RP is forbidden. Metagaming includes, but is not limited to, stream-sniping, 'passing' information between your characters, and using information acquired while spectating. If you are in any form of Voice Over IP call like Discord while in an active RP scene, you must deafen to prevent metagaming.", tags: ["metagaming", "streamsniping", "ooc", "ic", "discord", "deafen"], new: true },
            { customId: 4, category: "General", title: "Exploiting (Updated)", text: "Exploiting game bugs, server glitches, game mechanics, or out-of-game exploits for personal/group advantage is strictly prohibited and will result in a permanent ban. This includes using software/hardware crosshairs, abusing bugs/glitches, and lag-switching. All bugs and glitches should be reported properly to be fixed.", tags: ["exploit", "bug", "glitch", "hacking", "crosshairs", "ban"], new: true },
            { customId: 5, category: "General", title: "Terms of Service", text: "You must adhere to the Discord and FiveM Terms of Service at all times.", tags: ["tos", "fivem", "discord"], new: false },
            { customId: 6, category: "General", title: "Admin Situations & Abuse", text: "Do not interrupt staff situations. Abuse of the /report function (e.g., lying to regain lost items) may result in a kick or further punishment. If you have an issue with an RP situation, wait until it is over to report it.", tags: ["staff", "report abuse", "lying", "items"], new: true },
            { customId: 7, category: "General", title: "Bad Experiences / Toxicity", text: "If you have an issue with your RP experience, make a ticket and someone will be with you ASAP. Do not be toxic in any way in OOC. Name-calling or posting hate/sarcastic remarks towards the server/community will result in a ban.", tags: ["toxicity", "ooc", "ticket", "hate"], new: true },
            { customId: 8, category: "General", title: "Advertising", text: "Non-authorized advertising, including but not limited to other servers, websites, or self-promotion, in the Discord or in-game is not allowed.", tags: ["advertising", "self-promotion"], new: true },
            { customId: 9, category: "General", title: "Real-World Monetization (RMT)", text: "Transfer of real-world goods is NOT allowed between players for any purpose. Transferring or attempting to transfer in-game assets (money, vehicles, items) for any out-of-game or real-world money, trade, or services is NOT allowed and will result in both parties being permanently banned.", tags: ["rmt", "real world trade", "ban", "money"], new: true },
            { customId: 10, category: "General", title: "Staff Rules", text: "Pending an investigation due to blatant rule breaks, your staff role can be removed. Leaking information from Discord or anything associated with UKRP regarded as private can or will result in a ban or removal from staff.", tags: ["staff", "leaks", "private info"], new: true },
            { customId: 11, category: "General", title: "Character Deletion (CHAR DEL)", text: "If you delete your player, the staff holds no responsibility to return any items or cars. You must make a ticket if you wish to delete a player and keep your cars or items.", tags: ["char del", "deletion", "items", "cars"], new: true },
            { customId: 12, category: "General", title: "Lawyers", text: "To be confirmed (TBC) rule regarding lawyers.", tags: ["lawyers", "tbc"], new: true },
            { customId: 101, category: "Whitelist", title: "Whitelist Requirements (Mic/Language)", text: "A successful whitelist application requires a minimum age of 16, a functional microphone, and a basic understanding of roleplay concepts. Players who do not have a working microphone will be kicked. You must understand and speak English.", tags: ["age", "mic", "application", "english"], new: false },
            { customId: 102, category: "Whitelist", title: "First Whitelist Application", text: "Your first application will be reviewed leniently, and minor mistakes may be overlooked. However, you are still expected to understand and follow all server rules.", tags: ["application", "lenient", "review"], new: true },
            { customId: 103, category: "Whitelist", title: "Second Application Review", text: "If your first application is denied, your second application will be significantly more strict. You will be expected to show a clear understanding of the rules (especially the death-animation rule). Any mistakes may result in another denial.", tags: ["application", "strict", "denial"], new: true },
            { customId: 104, category: "Whitelist", title: "Third Whitelist Application Difficulty", text: "If you fail your second whitelist application, a third application will be extremely difficult to pass. You will be expected to demonstrate near-perfect knowledge of all rules, with zero tolerance for mistakes. A third attempt should be considered a last chance.", tags: ["application", "strict", "final", "near-impossible"], new: true },
            { customId: 105, category: "Whitelist", title: "Weekly Activity Requirement", text: "All whitelisted players must play at least 5 hours per week. Failure to meet this requirement may result in loss of whitelist status.", tags: ["activity", "time", "loss"], new: true },
            { customId: 106, category: "Whitelist", title: "Character Names (Updated)", text: "Character names must be realistic and not include profanity, offensive terms, or famous fictional characters. If the administration team deems any name you are using offensive or derogatory, they reserve the right to adjust or request you change your name. Re-adjusting your name from a suitable name can result in a ban.", tags: ["name", "realism", "offensive", "derogatory"], new: true },
            { customId: 107, category: "Whitelist", title: "Job Switching and Activity", text: "If you join a whitelisted job/business, you may not join another whitelisted job for 7 days and you must keep up an average of 7 hours per week per whitelisted job or role. Only one whitelisted job or role can be used per person. LOA (Leave of Absence) can be agreed upon for up to 28 days via a ticket.", tags: ["job", "whitelist", "activity", "loa"], new: true },
            { customId: 201, category: "Core RP", title: "FearRP (Failing To Value Life - FTVL)", text: "At all times you are to value your life. You must appropriately value your character's life. Do not engage in risky actions without genuine fear, especially when outnumbered or threatened with weapons. If you are clearly outnumbered or at an obvious disadvantage you should comply with demands. E.g., if held at gunpoint, you should comply.", tags: ["fear", "value of life", "ftvl", "compliance", "gunpoint"], new: false },
            { customId: 202, category: "Core RP", title: "Powergaming (Updated & Expanded)", text: "The use of game mechanics to gain an advantage over other players is forbidden. Performing actions that are physically impossible or giving yourself an unfair advantage in RP scenarios without allowing others a chance to react. Examples: Moving seats to get kicked out when cuffed; Cancelling animations; Sunbathing Through A Door (Instant PERM BAN); Pulling A Car Out Of A Garage While In A RP Situation to get away; Talking/Organising/Calling out locations while downed; Escorting people while in vehicles; Government employees not obeying road laws.", tags: ["powergaming", "impossible", "unfair", "/me", "cuff", "animation", "downed", "government"], new: true },
            { customId: 203, category: "Core RP", title: "New Life Rule (NLR) (Updated)", text: "Upon respawning or waking up in a hospital, your character forgets the events leading up to their death and cannot remember who killed them or where they died. The previous RP scene needs to be completely forgotten about. You may not return to your place of death until the RP scene is over. You may only remember the previous life if you have been revived by the Witch Doctor or NHS.", tags: ["nlr", "death", "hospital", "timer", "revive"], new: true },
            { customId: 204, category: "Core RP", title: "Initiation", text: "You must have verbal or clear non-verbal initiation before engaging in combat or hostile roleplay with another player.", tags: ["initiation", "hostile", "combat", "verbal"], new: false },
            { customId: 205, category: "Core RP", title: "Breaking RP (Updated)", text: "You must remain IC at all times while in the server. Breaking character by going OOC should not be happening unless a break-in RP has been initiated by an active member of the moderation team. The only OOC resources players have are Spawn, OOC-chat, and /report. Do not say things like: 'It's lag', 'I'm going to report you', 'That's not allowed your breaking server rules', or 'I don't want to roleplay this'.", tags: ["breaking rp", "ooc", "ic", "moderation"], new: true },
            { customId: 206, category: "Core RP", title: "Death Animation", text: "If you die and your player does not do the death animation, or you come out of it for any reason, you are to press 'E' to go back into the animation straight away. Anyone seen not doing this will get one warning before a 7-day ban for failing to RP their death. Do not hold 'E' to respawn and claim it was a mistake.", tags: ["death animation", "fail rp", "respawn"], new: true },
            { customId: 207, category: "Core RP", title: "Permanent Character Death (Suicide RP)", text: "Suicide RP: If you choose to commit suicide, that death will be PERMANENT. Your character will be deleted with no return. It is highly advised that you value your lives whilst in-character.", tags: ["pk", "perma-death", "suicide", "deletion"], new: true },
            { customId: 208, category: "Core RP", title: "Realism (Character Appearance)", text: "Character clothing must be realistic. Do your best to make sure arms do not show through shirts, etc. If this is an accidental bug please inform administration. If your character name is deemed unsuitable, you may be forced to recreate your character. ", tags: ["realism", "clothing", "bug"], new: true },
            { customId: 209, category: "Core RP", title: "Erotic RP", text: "Any type of forced sexual RP is forbidden. Failure to dis-engage sexual RP when requested/told will result in a ban.", tags: ["sexual rp", "forced rp", "erotic"], new: false },
            { customId: 210, category: "Core RP", title: "Random Deathmatch (RDM) / Poor RP Killings", text: "RDM is forbidden. Fighting and aggressive actions must be reasoned through RP. When killing someone, you must have both initiation and reason. The reason must be evident within that initiation. If either are not evident, it will be classed as RDM. This is primarily to stop one-or-no-sentence killings.", tags: ["rdm", "initiation", "reason", "killing"], new: true },
            { customId: 211, category: "Core RP", title: "FailRP", text: "FailRP is not allowed. This includes doing things that you wouldn’t do or wouldn’t be able to do IRL, interfering with LEO/NHS RP scenes unless you have a valid RP reason to be there, and being a fake hostage at a bank robbery. If you are found to be doing a robbery naked (taking clothes off to hide identity) you will be made to put your clothes back on.", tags: ["failrp", "realism", "leo", "nhs", "hostage"], new: true },
            { customId: 212, category: "Core RP", title: "GTA Driving / Realistic Consequences", text: "GTA Driving is now allowed to an extent. You are now allowed to do jumps, but these come with consequences as they need to be RP’d. For example, if you send your car flying off the side of a mountain, you are going to get hurt, so please RP it.", tags: ["gta driving", "realism", "consequences", "jumping"], new: true },
            { customId: 213, category: "Core RP", title: "Vehicle in Buildings / Meth", text: "Vehicles are not allowed inside buildings. There will also be no meth cooking underground or in railway tunnels.", tags: ["vehicle", "meth", "underground"], new: true },
            { customId: 214, category: "Core RP", title: "Impersonation and Military Zones", text: "Impersonating the NHS is not allowed unless permission is given by staff. This includes wearing any type of NHS clothing/accessories. It is also forbidden to enter the military base or the aircraft carrier (unless for your shop/trucking deliveries).", tags: ["impersonation", "nhs", "military", "restricted"], new: true },
            { customId: 215, category: "Core RP", title: "Spawn/Hospital Killing", text: "It is forbidden to rob, kidnap, or kill new players at the character creation location or players who have just respawned at the hospital. Camping spawn locations is forbidden.", tags: ["spawn kill", "hospital", "camping", "new players"], new: true },
            { customId: 216, category: "Core RP", title: "Terrorism RP", text: "Terrorism or Bomb RP in any way is not allowed unless cleared by a senior administrator. If you do do terrorist RP without authorization, the RP scene can continue, but your bomb will ultimately be classed as a dud. A fuel can does not count as a bomb.", tags: ["terrorism", "bomb rp", "extreme rp", "dud"], new: true },
            { customId: 301, category: "Combat", title: "Vehicle Deathmatch (VDM)", text: "VDM is forbidden and will result in scaled punishments. Any direct or purposely aggressive action with vehicles will be classed as VDM.", tags: ["vdm", "vehicle", "aggressive"], new: false },
            { customId: 302, category: "Combat", title: "Combat Logging (F8 Quitting) (Updated)", text: "Combat-logging, such as quitting the server during an RP situation/government sit will result in a punishment. F8 quitting or using any other means to quit while in an active RP scene will lead to a warning then bans. We have logs on how you exit, so this is easily found.", tags: ["combat logging", "disconnect", "f8 quit", "avoidance"], new: true },
            { customId: 303, category: "Combat", title: "Heavily Armed Gangs", text: "Only approved, whitelisted gangs with sufficient members (minimum 6) can engage in large-scale shootouts. Casual combat groups are limited to 4 members.", tags: ["gangs", "shootout", "whitelist", "member count"], new: false },
            { customId: 304, category: "Combat", title: "Hunting Rifles", text: "Using the hunting rifles against other players is not allowed under any circumstances. These are for hunting animals only. PERM BANS WILL BE GIVEN FOR ABUSING THIS RULE.", tags: ["hunting rifle", "weapon", "abuse", "perm ban"], new: true },
            { customId: 305, category: "Combat", title: "Drive-Bys", text: "Do not shoot from the driver's seat of a car (you can shoot from a bike). Do not shoot out of any vehicle unless windows are down. Do not by any means shoot from an armoured car unless the windows are down or doors are open.", tags: ["drive-by", "shooting", "vehicle", "armoured"], new: true },
            { customId: 306, category: "Combat", title: "Gang Member Limits", text: "Whitelisted Gangs are limited to a certain number of members, this can be discussed with the gang managers if the whitelist is successful.", tags: ["gangs", "member count", "whitelist"], new: true },
            { customId: 307, category: "Combat", title: "Vehicle vs. Pedestrian/Structure", text: "You cannot use a vehicle to intentionally run over pedestrians or ram into buildings in a hostile manner unless it is part of a detailed, pre-planned RP scenario (and is not an attempt at griefing).", tags: ["vehicle", "ramming", "griefing", "hostile"], new: false },
            { customId: 401, category: "Crime", title: "Robbery Limits (Updated)", text: "Players can only be robbed for a reasonable amount of cash and inventory items. Do not clear a player's entire bank account or all their assets. It is forbidden to force people to transfer/withdraw money from the bank, and it is also forbidden to force players to transfer you their vehicles.", tags: ["robbery", "limits", "bank", "inventory", "transfer"], new: true },
            { customId: 402, category: "Crime", title: "Hostage Taking (Duration)", text: "A valid hostage must be a player who is not associated with the crime group and is clearly RPing fear. Staff intervention is often required for large-scale hostage situations. The maximum you can hold someone hostage for is 30 minutes, however, this rule does not apply if you are already engaged in a situation with the police, such as a bank robbery.", tags: ["hostage", "duration", "kidnapping", "staff"], new: true },
            { customId: 403, category: "Crime", title: "Government/LEO/EMS Harassment", text: "Excessive or unrealistic harassment of Law Enforcement (LEO) or Emergency Medical Services (EMS) is prohibited. They are essential to the server's RP and must be respected.", tags: ["leo", "ems", "harassment", "government"], new: false },
            { customId: 404, category: "Crime", title: "Police Raids (House Keys)", text: "IF police raid your house and you are inside or they wait for you to come home, then you must, when cuffed, give them your keys to the house. If you do not do this, it will be seen as Powergaming.", tags: ["police raid", "keys", "powergaming"], new: true },
            { customId: 405, category: "Crime", title: "Robbery and Raids on Properties (Player Wait)", text: "We ask that players are given a chance by letting them be in the server before this happens, so please wait for the player in question to join before robbing or raiding their house. YOU DO NOT NEED TO FOLLOW THIS RULE UNLESS ANNOUNCED MI5 INACTIVE RULE.", tags: ["raid", "player wait", "mi5"], new: true },
            { customId: 406, category: "Crime", title: "Daylight Saving Cameras", text: "If you are in the main city limits, it is daytime, and you proceed to kill officers, this will be classed as a street camera and a dead or alive warrant will be issued. Be careful.", tags: ["cameras", "daylight", "leo", "warrant"], new: true },
            { customId: 407, category: "Crime", title: "Player Robbery (Specific Stealing Limits)", text: "NHS or Police issued weapons must NOT be stolen. You can '/me takes weapons'. The officer or NHS worker will then have to disregard the weapon in their inventory for the rest of the RP scene. You MAY steal GPS, AMMO, ARMOUR, EVIDENCE (= GUNS DRUGS MONEY BAGS ETC), HANDCUFFS, and CUFF KEYS that are on an officer. Anything else is fair game.", tags: ["robbery", "police", "nhs", "weapons", "limits"], new: true },
            { customId: 408, category: "Crime", title: "Evidence", text: "Do not by any means take anything from police evidence. You will be banned from all whitelists for 1 month and, if decided, you will also be banned from the server.", tags: ["evidence", "police", "stealing", "ban"], new: true },
            { customId: 409, category: "Crime", title: "Custody", text: "After being treated by the NHS or arrested by MPS (Police), you are in their custody until cleared or escaped. Not doing so will be treated as FailRP.", tags: ["custody", "nhs", "police", "failrp"], new: true },
            { customId: 410, category: "Crime", title: "Bank Robbery Limits", text: "In a bank robbery, a maximum of 4 robbers are allowed inside the robbery or a maximum of 6 robbers are allowed inside the bobcat or big bank robbery, with a maximum of 2 hostages allowed.", tags: ["bank", "robbery", "limits", "hostages"], new: true },
            { customId: 411, category: "Crime", title: "Restart Crime Limits", text: "No illegal activity is allowed 30 minutes before and 15 minutes after restart. Selling drugs, robbing a person, murdering a person, and discharging a firearm are not allowed 15 minutes before and 15 minutes after a restart.", tags: ["restart", "crime", "timing"], new: true },
            { customId: 412, category: "Crime", title: "Kidnapping Cooldown", text: "You can only kidnap the same person or group once every 2 hours. If a member of your whitelisted gang has already kidnapped or murdered a player, no other member of your gang can initiate hostile RP towards that same player until that timer is up.", tags: ["kidnapping", "cooldown", "gangs"], new: true },
            { customId: 413, category: "Crime", title: "Police Kidnapping", text: "You can kidnap police if there is an RP reason to do so and there has to be more than 1 officer online.", tags: ["police", "kidnapping", "leo"], new: true },
            { customId: 414, category: "Crime", title: "NHS Hostile RP", text: "You are not to initiate any hostile RP towards the NHS. However, if they are hostile to you for any reason, you are able to retaliate accordingly. This also includes attempting to murder the person the NHS is giving medical treatment to secure a no revive.", tags: ["nhs", "hostile rp", "retaliate", "no revive"], new: true },
            { customId: 415, category: "Crime", title: "Robbing Food", text: "It is forbidden to rob any food or drinks from players.", tags: ["robbery", "food", "drinks"], new: true },
            { customId: 416, category: "Crime", title: "Forbidden Weapons to Steal", text: "It is forbidden to steal police-issued weapons/heavy ammo. These include: Combat Pistol, Stun gun, SMG, Special Carbine, Heavy Sniper, Pump Shotgun, and heavy ammo boxes.", tags: ["weapons", "police", "heavy ammo"], new: true },
            { customId: 501, category: "Economy", title: "Selling Stolen Goods", text: "Selling stolen or illegally acquired items/vehicles requires legitimate RP interaction. You cannot use OOC chat or random teleportation to conduct illegal sales.", tags: ["selling", "stolen", "illegal", "rp"], new: false },
            { customId: 502, category: "Economy", title: "Money Laundering", text: "Large amounts of illicit money must be laundered through RP-appropriate means. Arbitrary transfer of large sums of cash between players without a clear RP reason is considered exploiting.", tags: ["money laundering", "cash transfer", "exploit"], new: false },
            { customId: 503, category: "Economy", title: "Triple Threat Shop Prices", text: "If you have items in your shop more than triple the item price and it's bought and reported, your shop will be removed.", tags: ["shop", "pricing", "exploit"], new: true },
            { customId: 504, category: "Economy", title: "Redline Showroom Nitro Cars", text: "Redline Showroom Nitro Cars can not be used for anything except racing or city driving. No criminal elements involved. Your car will be taken and impounded if found on the road or left unattended. Transport cars using trailers to racing events or risk being chased.", tags: ["redline", "nitro", "racing", "impound", "crime"], new: true },
            { customId: 505, category: "Economy", title: "Paycheck Farming", text: "Paycheck farming while AFK is not allowed. For example, being NHS/mechanics and going on duty and not doing your job is not allowed. This will result in a punishment or potential removal from your whitelisted job.", tags: ["paycheck", "afk", "farming", "job"], new: true },
            { customId: 506, category: "Economy", title: "Business Owner - Employee Responsibility", text: "You have a responsibility for your employees. You must be able to pay their wages and make sure they follow the rules. Failing to do so will result in the termination of your business ownership.", tags: ["business", "employees", "wages"], new: true },
            { customId: 507, category: "Economy", title: "Business Owner - Service Priority", text: "If you own a business that provides a service, such as mechanics, you must make sure you are providing that service. For example, you must repair and tune people’s vehicles as a mechanic, and prioritize this over any other activities, such as crime.", tags: ["business", "mechanic", "prioritize", "crime"], new: true },
            { customId: 508, category: "Economy", title: "CID/Gang Conflict", text: "You may not be a part of a gang and CID (in the MPS) at the same time (this includes across characters and staff members, unless authorized).", tags: ["cid", "gang", "conflict", "whitelist job"], new: true },
            { customId: 509, category: "Economy", title: "Corrupt Cop RP", text: "Corrupt cop RP is only allowed to overlook items in a search. No other corrupt whitelisted job RP is allowed.", tags: ["corrupt", "cop", "search"], new: true },
            { customId: 510, category: "Economy", title: "Scamming", text: "It is not permitted to ‘scam’ players for their vehicles or sell vehicles on the phone app for more than a maximum value of £10mill. You may only ‘scam’ players for illegal items (such as weapons or heist equipment etc.) with a value of £500,000 or less.", tags: ["scamming", "vehicles", "illegal items", "money"], new: true },
            { customId: 511, category: "Economy", title: "Real Estate - Cayo Perico", text: "Real estate must not conduct business or sell any properties on the Cayo Perico island.", tags: ["real estate", "cayo perico", "selling"], new: true },
            { customId: 512, category: "Economy", title: "Real Estate - House Selling Value", text: "You must stick to the value that is on your sheet. You are only allowed to upsell to a certain percentage, which will only be disclosed to the real estate agents.", tags: ["real estate", "upsell", "value"], new: true },
            { customId: 601, category: "Zones", title: "Green Zones (Safe Zones) (Updated)", text: "No hostile actions (robbing, kidnapping, combat initiation) are allowed while inside designated Green Zones (e.g., Hospitals, JobCentre, Mechanic Shop, Real Estate Office, Police Impound, Trucking Building, Underground Racing Zone). While in Hostile RP or Combat, you must avoid these locations. If someone does run inside while in active RP, the RP scene can continue BUT the person may still be reported for the rule break.", tags: ["green zone", "safe zone", "combat", "hospital", "job centre"], new: true },
            { customId: 602, category: "Zones", title: "Restricted Military/Airspace", text: "Military bases and restricted airspaces are off-limits unless you have explicit in-character permission (e.g., a LEO pilot) or staff approval for a specific scenario.", tags: ["military", "airspace", "restricted", "leo"], new: false },
            { customId: 603, category: "Zones", title: "Character Creation Spawn Zone", text: "You must not initiate any hostile RP or combat inside the Character Creation Spawn Zone. Camping inside is forbidden. Hostile RP or combat MUST NOT be brought into these locations whatsoever.", tags: ["spawn", "camping", "hostile", "creation"], new: true },
            { customId: 701, category: "Aircraft", title: "Low-Altitude Flying", text: "Aircraft must maintain a safe and reasonable altitude when flying over city centers and residential areas. Stunt flying in these areas is prohibited.", tags: ["aircraft", "flying", "altitude", "stunt"], new: false },
            { customId: 702, category: "Aircraft", title: "Emergency Landing", text: "In the event of an aircraft emergency, the pilot must RP a realistic landing scenario and notify air traffic control (if present) or nearby LEO/EMS.", tags: ["aircraft", "landing", "emergency", "rp"], new: false },
            { customId: 703, category: "Aircraft", title: "Theft and Military Vehicles", text: "You are allowed to steal aircraft, however, you are not allowed to steal military vehicles.", tags: ["aircraft", "stealing", "military"], new: true },
            { customId: 704, category: "Aircraft", title: "Collisions and Life Value", text: "You must not deliberately collide with any other aircraft, people, or buildings whilst flying. You must value your life in an aircraft.", tags: ["collision", "value of life", "flying"], new: true },
            { customId: 705, category: "Aircraft", title: "Realistic Flying", text: "You must fly realistically. This means you must not fly under bridges, close to buildings, etc. You must value your life in an aircraft.", tags: ["flying", "realism", "bridges"], new: true },
            { customId: 706, category: "Aircraft", title: "Aircraft Garages", text: "You may only store aircraft in aircraft garages. Failure to do so will result in your aircraft being removed and your licenses being stripped. Additionally, you must not use the impound feature to bring out aircraft or boats at car garages.", tags: ["garage", "storage", "impound", "licenses"], new: true },
            { customId: 707, category: "Aircraft", title: "Flying Zones", text: "You must not fly PLANES and LAND Helicopters in the zones marked red and blue unless it's on a helipad or runway. You must not fly HELICOPTERS in the zones marked blue. Landing needs to be realistic, no landing in the streets/garages or on top of houses (only NHS and Police are exempt).", tags: ["zones", "restricted", "planes", "helicopters", "landing"], new: true },
            { customId: 801, category: "Discord", title: "Respect and Conduct", text: "All members must be treated with respect. Harassment, hate speech, racism, sexism, and toxicity towards other members or staff are strictly prohibited and will result in an immediate ban.", tags: ["discord", "respect", "conduct", "toxicity"], new: true },
            { customId: 802, category: "Discord", title: "No Advertising", text: "Do not advertise other servers, websites, or services in any text channel or direct messages (DMs) to other members. Self-promotion is only allowed in designated channels if applicable.", tags: ["discord", "advertising", "spam"], new: true },
            { customId: 803, category: "Discord", title: "Follow Discord ToS", text: "You must adhere to the official Discord Terms of Service and Community Guidelines at all times.", tags: ["discord", "tos", "guidelines"], new: false },
            { customId: 804, category: "Discord", title: "Ticket System Usage", text: "Use the ticket system for all reports, ban appeals, and support inquiries. Do not direct message (DM) staff members for support unless explicitly told to do so.", tags: ["discord", "ticket", "support", "staff"], new: true },
            { customId: 805, category: "Discord", title: "Spam and Pinging", text: "Do not spam text channels with messages, emojis, or caps. Do not ping staff members or roles without a valid reason. Mass pinging is prohibited.", tags: ["discord", "spam", "pinging"], new: false },
            { customId: 806, category: "Discord", title: "Profile Guidelines", text: "Usernames, nicknames, and profile pictures must be appropriate (SFW) and not contain offensive language or imagery.", tags: ["discord", "profile", "nsfw", "username"], new: false },
            { customId: 807, category: "Discord", title: "Channel Usage", text: "Ensure you are using the correct channels for their intended purpose (e.g., keeping general chat in #general, posting media in #media, etc.).", tags: ["discord", "channels", "topic"], new: false },
        ];
        
        let fetchedRules = [];

        // AUTH & LISTENER
        async function init() {
            try {
                // FIX: When using a custom Firebase project, the system-provided __initial_auth_token
                // is invalid (causes auth/custom-token-mismatch). We must use signInAnonymously instead.
                // Ensure "Anonymous" is enabled in your Firebase Console > Authentication > Sign-in method.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch(e) { 
                console.error("Auth failed", e); 
            }

            onAuthStateChanged(auth, (user) => {
                if(user) {
                    const q = query(collection(db, ...rulesColPath));
                    onSnapshot(q, (snapshot) => {
                        fetchedRules = [];
                        snapshot.forEach((docSnap) => {
                            fetchedRules.push({ docId: docSnap.id, ...docSnap.data() });
                        });
                        
                        // MERGE: Base Rules (Read-Only) + Fetched Rules (Editable)
                        // Sort by customId
                        const allRules = [...window.staticBaseRules, ...fetchedRules].sort((a, b) => (a.customId || 0) - (b.customId || 0));
                        
                        window.rulesData = allRules;
                        
                        // Hide banner if connection successful
                        const banner = document.getElementById('dbStatusBanner');
                        if(banner) banner.classList.add('hidden');
                        
                        if (window.filterRules) window.filterRules();
                    }, (error) => {
                        console.warn("Firestore access restricted (ReadOnly Mode):", error.message);
                        // Even if fetch fails, show base rules and notify user
                        window.rulesData = window.staticBaseRules;
                        
                        const banner = document.getElementById('dbStatusBanner');
                        if(banner) {
                            banner.classList.remove('hidden');
                            banner.classList.add('flex');
                        }
                        
                        if (window.filterRules) window.filterRules();
                    });
                } else {
                     // If auth fails/not ready, at least show base rules
                    window.rulesData = window.staticBaseRules;
                    if (window.filterRules) window.filterRules();
                }
            });
        }
        init();

        // GLOBAL FUNCTIONS FOR UI
        window.handleRuleSubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('saveRuleBtn');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            const docId = document.getElementById('ruleDocId').value;
            const customId = parseInt(document.getElementById('ruleCustomId').value);
            const category = document.getElementById('ruleCategory').value;
            const title = document.getElementById('ruleTitle').value;
            const text = document.getElementById('ruleText').value;
            const isNew = document.getElementById('ruleNew').checked;

            const ruleData = { customId, category, title, text, new: isNew, tags: [] };

            try {
                if (docId) {
                    await updateDoc(doc(db, ...rulesColPath, docId), ruleData);
                } else {
                    await addDoc(collection(db, ...rulesColPath), ruleData);
                }
                window.closeModal('ruleModal');
            } catch (err) {
                alert("Error saving rule: " + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        window.deleteRule = async function(docId) {
            if(confirm("Are you sure you want to delete this rule? This cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, ...rulesColPath, docId));
                } catch(err) {
                    alert("Error deleting: " + err.message + "\n\n(Check your database permissions)");
                }
            }
        };

        // UI SCRIPTS
        window.activeCategoryFilter = 'All';
        window.isAdmin = false;

        window.switchPage = function(pageName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if(document.getElementById(`nav-${pageName}`)) {
                document.getElementById(`nav-${pageName}`).classList.add('active');
            }
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active-page');
                setTimeout(() => {
                    if(!section.classList.contains('active-page')) section.style.display = 'none';
                }, 400); 
            });
            const selectedPage = document.getElementById(`page-${pageName}`);
            selectedPage.style.display = 'block';
            requestAnimationFrame(() => selectedPage.classList.add('active-page'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.openLoginModal = function() {
            const m = document.getElementById('loginModal');
            m.classList.remove('hidden');
            m.classList.add('flex');
            setTimeout(() => {
                m.querySelector('.modal-content').classList.remove('scale-95');
                m.querySelector('.modal-content').classList.add('scale-100');
            }, 10);
            document.getElementById('adminUser').focus();
        }

        window.closeModal = function(modalId) {
            const m = document.getElementById(modalId);
            const c = m.querySelector('.modal-content');
            c.classList.remove('scale-100');
            c.classList.add('scale-95');
            setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); }, 200);
            
            if(modalId === 'ruleModal') {
                document.getElementById('ruleDocId').value = '';
                document.getElementById('ruleTitle').value = '';
                document.getElementById('ruleText').value = '';
                document.getElementById('ruleCustomId').value = '';
                document.getElementById('ruleNew').checked = false;
            }
        }

        window.handleLogin = function(e) {
            e.preventDefault();
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if (u === 'admin' && p === 'ukrp2024') {
                setAdminState(true);
                sessionStorage.setItem('ukrp_admin_session', 'true');
                closeModal('loginModal');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        window.logout = function() {
            setAdminState(false);
            sessionStorage.removeItem('ukrp_admin_session');
        }

        function setAdminState(isLoggedIn) {
            window.isAdmin = isLoggedIn;
            const loginBtn = document.getElementById('adminLoginBtn');
            const panel = document.getElementById('adminPanel');
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                panel.classList.remove('hidden');
                panel.classList.add('flex');
            } else {
                loginBtn.classList.remove('hidden');
                panel.classList.add('hidden');
                panel.classList.remove('flex');
            }
            if (window.filterRules) window.filterRules();
        }

        if(sessionStorage.getItem('ukrp_admin_session') === 'true') {
            setAdminState(true);
        }

        window.openRuleModal = function(docId = null) {
            const m = document.getElementById('ruleModal');
            m.classList.remove('hidden'); m.classList.add('flex');
            
            const titleEl = document.getElementById('modalTitle');
            const docIdInput = document.getElementById('ruleDocId');
            const customIdInput = document.getElementById('ruleCustomId');
            const catInput = document.getElementById('ruleCategory');
            const titleInput = document.getElementById('ruleTitle');
            const textInput = document.getElementById('ruleText');
            const newCheck = document.getElementById('ruleNew');

            if (docId) {
                // Edit
                const rule = window.rulesData.find(r => r.docId === docId);
                if (!rule) return;
                
                titleEl.textContent = "Edit Rule";
                docIdInput.value = rule.docId;
                customIdInput.value = rule.customId;
                catInput.value = rule.category;
                titleInput.value = rule.title;
                textInput.value = rule.text;
                newCheck.checked = rule.new;
            } else {
                // Add
                titleEl.textContent = "Add New Rule";
                docIdInput.value = "";
                // Guess next ID from ALL rules
                const maxId = window.rulesData.reduce((max, r) => Math.max(max, r.customId || 0), 0);
                customIdInput.value = maxId + 1;
                
                catInput.value = (activeCategoryFilter !== 'All') ? activeCategoryFilter : "General";
                titleInput.value = "";
                textInput.value = "";
                newCheck.checked = true;
            }
        }

        // --- FILTER & RENDER ---
        window.filterRules = function() {
            if(!window.rulesData) return;
            
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            document.getElementById('clearSearchBtn').classList.toggle('hidden', term.length === 0);

            let filtered = window.rulesData;
            if (term) {
                filtered = filtered.filter(r => 
                    r.title.toLowerCase().includes(term) || 
                    r.text.toLowerCase().includes(term) ||
                    (r.tags && r.tags.some(t => t.includes(term)))
                );
            }
            if (window.activeCategoryFilter !== 'All') {
                filtered = filtered.filter(r => r.category === window.activeCategoryFilter);
            }
            renderRules(filtered);
        }

        window.filterByCategory = function(cat) {
            document.getElementById('searchInput').value = '';
            window.activeCategoryFilter = (window.activeCategoryFilter === cat && cat !== 'All') ? 'All' : cat;
            filterRules();
            switchPage('rules');
        }

        function renderRules(filteredRules) {
            const container = document.getElementById('ruleContainer');
            if(!container) return;
            container.innerHTML = ''; 

            if (filteredRules.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-500 text-xl font-light">No rules found matching your criteria.</div>`;
                return;
            }

            // Sync Buttons
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if (btn.getAttribute('data-category') === window.activeCategoryFilter) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const categoryMap = {
                "General": { class: 'general-rule', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
                "Whitelist": { class: 'whitelist-rule', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
                "Core RP": { class: 'core-rp-rule', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' },
                "Combat": { class: 'combat-rule', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                "Crime": { class: 'crime-rule', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' },
                "Economy": { class: 'economy-rule', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
                "Zones": { class: 'zones-rule', icon: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z' },
                "Aircraft": { class: 'aircraft-rule', icon: 'M12 19l9 2-9-18-9 18 9-2zm0 0v-8' },
                "Discord": { class: 'discord-rule', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z' },
            };

            const groupedRules = filteredRules.reduce((acc, rule) => {
                if (!acc[rule.category]) acc[rule.category] = [];
                acc[rule.category].push(rule);
                return acc;
            }, {});

            Object.keys(groupedRules).forEach(category => {
                const map = categoryMap[category] || categoryMap["General"]; 
                
                const section = document.createElement('div');
                section.className = 'mb-12';
                section.innerHTML = `
                    <div class="flex items-center space-x-3 mb-6 border-b border-slate-800 pb-2">
                        <svg class="w-6 h-6" style="color: ${getComputedStyle(document.body).getPropertyValue('--color-' + category.toLowerCase().replace(' ', '-')) || '#fff'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${map.icon}"></path></svg>
                        <h3 class="text-2xl font-bold text-white">${category} Rules</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                `;
                
                const grid = section.querySelector('.grid');
                groupedRules[category].forEach(rule => {
                    const card = document.createElement('div');
                    card.className = `rule-card p-6 rounded-xl relative group ${map.class}`;
                    
                    let adminHtml = '';
                    
                    // Admin Logic for Editable vs Locked
                    if(window.isAdmin) {
                        if (rule.docId) {
                            // EDITABLE (Database Rule)
                            adminHtml = `
                                <div class="absolute top-4 right-4 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openRuleModal('${rule.docId}')" class="p-1.5 bg-blue-600/80 hover:bg-blue-600 rounded-md text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                                    <button onclick="deleteRule('${rule.docId}')" class="p-1.5 bg-red-600/80 hover:bg-red-600 rounded-md text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            `;
                        } else {
                            // LOCKED (Base Rule)
                            adminHtml = `
                                <div class="absolute top-4 right-4 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity" title="Base Rule (Cannot be edited)">
                                    <span class="p-1.5 bg-slate-700/80 rounded-md text-slate-400 cursor-not-allowed">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    </span>
                                </div>
                            `;
                        }
                    }

                    const newBadge = rule.new ? `<span class="new-tag text-[10px] font-bold px-2 py-0.5 rounded ml-2 uppercase tracking-wide">New</span>` : '';
                    const baseBadge = !rule.docId ? `<span class="base-tag text-[10px] font-bold px-2 py-0.5 rounded ml-2 uppercase tracking-wide" title="Core Rule">Base</span>` : '';

                    card.innerHTML = `
                        ${adminHtml}
                        <div class="flex items-start justify-between mb-3">
                            <h4 class="text-lg font-bold text-white flex items-center flex-wrap gap-2">
                                <span class="opacity-50 text-sm">#${rule.customId}</span>
                                ${rule.title}
                                ${newBadge}
                                ${baseBadge}
                            </h4>
                        </div>
                        <p class="text-slate-300 leading-relaxed text-sm">${rule.text}</p>
                    `;
                    grid.appendChild(card);
                });

                container.appendChild(section);

                if (category === "Aircraft") {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mt-6 w-full max-w-2xl mx-auto';
                    imgDiv.innerHTML = `<img src="https://i.gyazo.com/fad0f3f014c5988a6ac3218d7409e33f.png" class="rounded-xl shadow-2xl border border-slate-700 w-full hover:scale-[1.02] transition-transform duration-500">`;
                    container.appendChild(imgDiv);
                }
            });
        }

        // Search Handlers
        let debounce;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(debounce);
            debounce = setTimeout(() => { window.activeCategoryFilter = 'All'; filterRules(); }, 300);
        });
        document.getElementById('clearSearchBtn').onclick = () => {
            document.getElementById('searchInput').value = '';
            filterRules();
        };

        // Scroll Handler
        const backToTop = document.getElementById('backToTopBtn');
        window.onscroll = () => {
            if(window.scrollY > 400) {
                backToTop.classList.remove('opacity-0', 'translate-y-10');
            } else {
                backToTop.classList.add('opacity-0', 'translate-y-10');
            }
        };
        backToTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
    </script>
</body>
</html>
